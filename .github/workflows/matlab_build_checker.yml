# This is a basic workflow that conducts a build check on the matlab code in the repository

name: Matlab Build Checker

on:
  push:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened]

jobs:
  matlab_build_checker:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v2 # Checks-out your repository under $GITHUB_WORKSPACE, so job can access it

      # Find the PR associated with this push, if there is one.
      - uses: jwalton/gh-find-current-pr@v1
        id: findPr

      - name: execute matlab checkcode
        run: |
          matlab -batch "addpath(genpath('.')); addpath('.github/workflows'); assert_matlab_checkcode('auth')"

      - name: execute matlab runtests
        run: |
          matlab -batch "addpath(genpath('.')); addpath('.github/workflows'); execute_matlab_tests_into_xml(pwd,'matlab_test_results.xml','matlab_unittest_coverage_report.xml')"

      - name: publish unit test results
        uses: mikepenz/action-junit-report@v1
        with:
          report_paths: 'matlab_test_results.xml'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: publish cobertura coverage report
        if: github.event_name == 'pull_request' || success() && steps.findPr.outputs.number # only happens if pull request exists
        uses: 5monkeys/cobertura-action@v8
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }} # The GITHUB_TOKEN for this repo
          path: matlab_unittest_coverage_report.xml # Path to the cobertura file.
          skip_covered: false # If files with 100% should be skipped from report.
          minimum_coverage: 100 # Minimum allowed coverage percentage as an integer.
          show_line: true # Show line rate as specific column.
          show_branch: true # Show branch rate as specific column.
          show_class_names: true # Show class names instead of file names.
          show_missing: true # Show line numbers of statements, per module, that was not executed.
          pull_request_number: ${{ steps.findPr.outputs.number }}
          only_changed_files: true # Only show coverage for changed files.
          report_name: matlab unittest coverage report # Use a unique name for the report and comment.
